# –°–æ–∑–¥–∞–Ω–∏–µ –ú–∏—Ä–∞ - –ü—Ä–æ—Ü–µ—Å—Å –Ω–∞ –§—Ä–æ–Ω—Ç–µ–Ω–¥–µ

## –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ
1. [–û–±–∑–æ—Ä](#–æ–±–∑–æ—Ä)
2. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)
3. [–ü–æ—à–∞–≥–æ–≤—ã–π –ü—Ä–æ—Ü–µ—Å—Å](#–ø–æ—à–∞–≥–æ–≤—ã–π-–ø—Ä–æ—Ü–µ—Å—Å)
4. [API –ó–∞–ø—Ä–æ—Å—ã](#api-–∑–∞–ø—Ä–æ—Å—ã)
5. [–ü–æ—Ç–æ–∫–∏ –î–∞–Ω–Ω—ã—Ö](#–ø–æ—Ç–æ–∫–∏-–¥–∞–Ω–Ω—ã—Ö)
6. [–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã UI](#–∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã-ui)

---

## –û–±–∑–æ—Ä

–ü—Ä–æ—Ü–µ—Å—Å —Å–æ–∑–¥–∞–Ω–∏—è –º–∏—Ä–∞ –≤ TaleSpinner - —ç—Ç–æ –º–Ω–æ–≥–æ—à–∞–≥–æ–≤—ã–π wizard, –∫–æ—Ç–æ—Ä—ã–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç AI-–∞–≥–µ–Ω—Ç—ã –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –±–æ–≥–∞—Ç–æ–≥–æ –∏–≥—Ä–æ–≤–æ–≥–æ –º–∏—Ä–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –≤–≤–æ–¥–∞. –ü—Ä–æ—Ü–µ—Å—Å –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º —á–µ—Ä–µ–∑ Effector –∏ –≤–∫–ª—é—á–∞–µ—Ç Human-in-the-Loop (HITL) –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ.

### –û—Å–Ω–æ–≤–Ω—ã–µ –≠—Ç–∞–ø—ã:
1. **–í—ã–±–æ—Ä –ñ–∞–Ω—Ä–∞** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç —Å–µ—Ç—Ç–∏–Ω–≥ (—Ñ—ç–Ω—Ç–µ–∑–∏)
2. **–û–ø–∏—Å–∞–Ω–∏–µ –ú–∏—Ä–∞** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–ø–∏—Å—ã–≤–∞–µ—Ç –∂–µ–ª–∞–µ–º—ã–π –º–∏—Ä
3. **–£—Ç–æ—á–Ω–µ–Ω–∏–µ –î–µ—Ç–∞–ª–µ–π** - AI –∑–∞–¥–∞–µ—Ç –≤–æ–ø—Ä–æ—Å—ã –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–∫–µ–ª–µ—Ç –º–∏—Ä–∞
4. **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è** - AI –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –º–∏—Ä–∞
5. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### State Management (Effector)

**–û—Å–Ω–æ–≤–Ω—ã–µ Stores:**
```typescript
$step         // –¢–µ–∫—É—â–∏–π —à–∞–≥ wizard: 'setting' | 'input' | 'questions' | 'generating' | 'review'
$sessionId    // ID —Å–µ—Å—Å–∏–∏ —Å–æ–∑–¥–∞–Ω–∏—è –º–∏—Ä–∞
$setting      // –í—ã–±—Ä–∞–Ω–Ω—ã–π –∂–∞–Ω—Ä (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 'fantasy')
$userInput    // –¢–µ–∫—Å—Ç –æ–ø–∏—Å–∞–Ω–∏—è –º–∏—Ä–∞ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
$analysis     // –†–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –≤–≤–æ–¥–∞
$questions    // –°–ø–∏—Å–æ–∫ –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è (derived from $analysis)
$answers      // –û—Ç–≤–µ—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã
$clarificationRequest  // HITL –∑–∞–ø—Ä–æ—Å –Ω–∞ —É—Ç–æ—á–Ω–µ–Ω–∏–µ –≤–æ –≤—Ä–µ–º—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
$generationProgress    // –ü—Ä–æ–≥—Ä–µ—Å—Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (—Å—Ç–∞—Ç—É—Å –∫–∞–∂–¥–æ–≥–æ –∞–≥–µ–Ω—Ç–∞)
$worldData    // –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –º–∏—Ä–∞
$error        // –û—à–∏–±–∫–∏
```

**Effects (API –≤—ã–∑–æ–≤—ã):**
```typescript
startSessionFx      // –ó–∞–ø—É—Å–∫ –Ω–æ–≤–æ–π —Å–µ—Å—Å–∏–∏
analyzeInputFx      // –ê–Ω–∞–ª–∏–∑ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –≤–≤–æ–¥–∞
submitAnswersFx     // –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã (deprecated)
startGenerationFx   // –°—Ç–∞—Ä—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (—Å Architect)
continueGenerationFx // –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–æ—Å–ª–µ HITL
generateWorldFx     // –ü–æ–ª—É—á–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ–≥–æ –º–∏—Ä–∞
saveWorldFx         // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–∏—Ä–∞ –≤ –ë–î
```

### –§–∞–π–ª–æ–≤–∞—è –°—Ç—Ä—É–∫—Ç—É—Ä–∞
```
frontend/src/features/world-creation/
‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îú‚îÄ‚îÄ agent-api.ts          # API –∫–ª–∏–µ–Ω—Ç
‚îÇ   ‚îî‚îÄ‚îÄ index.ts
‚îú‚îÄ‚îÄ model/
‚îÇ   ‚îú‚îÄ‚îÄ events.ts             # Effector events
‚îÇ   ‚îú‚îÄ‚îÄ effects.ts            # Effector effects
‚îÇ   ‚îú‚îÄ‚îÄ stores.ts             # Effector stores
‚îÇ   ‚îú‚îÄ‚îÄ init.ts               # –°–≤—è–∑–∏ –º–µ–∂–¥—É —Å–æ–±—ã—Ç–∏—è–º–∏ (sample)
‚îÇ   ‚îú‚îÄ‚îÄ types.ts              # TypeScript —Ç–∏–ø—ã
‚îÇ   ‚îî‚îÄ‚îÄ sse.ts                # SSE –ø–æ–¥–¥–µ—Ä–∂–∫–∞
‚îú‚îÄ‚îÄ ui/
‚îÇ   ‚îú‚îÄ‚îÄ wizard/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ wizard.tsx        # –ì–ª–∞–≤–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç wizard
‚îÇ   ‚îú‚îÄ‚îÄ steps/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ genre-selection.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ world-input.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ question-form.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ skeleton-preview.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ generation-progress.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ world-review.tsx
‚îÇ   ‚îî‚îÄ‚îÄ index.ts
‚îî‚îÄ‚îÄ index.ts                  # –ü—É–±–ª–∏—á–Ω—ã–π API —Ñ–∏—á–∏
```

---

## –ü–æ—à–∞–≥–æ–≤—ã–π –ü—Ä–æ—Ü–µ—Å—Å

### –®–∞–≥ 1: –í—ã–±–æ—Ä –ñ–∞–Ω—Ä–∞ (Genre Selection)

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç:** `GenreSelection`  
**–°–æ—Å—Ç–æ—è–Ω–∏–µ:** `$step = 'setting'`

#### –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –∫–∞—Ä—Ç–æ—á–∫–∏ —Å –∂–∞–Ω—Ä–∞–º–∏ (–ø–æ–∫–∞ —Ç–æ–ª—å–∫–æ Fantasy)
2. –ü—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∂–∞–Ω—Ä:
   - –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è `$setting` (setSetting event)
   - –í—ã–∑—ã–≤–∞–µ—Ç—Å—è `startSessionFx({ setting: 'fantasy' })`

#### API –ó–∞–ø—Ä–æ—Å:
```typescript
POST /api/world-creation/agent/start
Body: { setting: 'fantasy' }

Response: {
  sessionId: string  // UUID —Å–µ—Å—Å–∏–∏
}
```

#### –†–µ–∑—É–ª—å—Ç–∞—Ç:
- `$sessionId` —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç ID —Å–µ—Å—Å–∏–∏
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —à–∞–≥ `input` (—á–µ—Ä–µ–∑ sample –≤ init.ts)

---

### –®–∞–≥ 2: –û–ø–∏—Å–∞–Ω–∏–µ –ú–∏—Ä–∞ (World Input)

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç:** `WorldInput`  
**–°–æ—Å—Ç–æ—è–Ω–∏–µ:** `$step = 'input'`

#### –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –æ–ø–∏—Å–∞–Ω–∏–µ –º–∏—Ä–∞ –≤ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –ø–æ–ª–µ
2. –ï—Å—Ç—å suggestions (–ø–æ–¥—Å–∫–∞–∑–∫–∏ —Ç–∏–ø–∞ "–õ–µ—Ç–∞—é—â–∏–µ –æ—Å—Ç—Ä–æ–≤–∞", "–î—Ä–∞–∫–æ–Ω—ã")
3. –ö–Ω–æ–ø–∫–∞ "–£–¥–∏–≤–∏ –º–µ–Ω—è" - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ
4. –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ "–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å":
   - –í—ã–∑—ã–≤–∞–µ—Ç—Å—è `analyzeInputFx({ sessionId, userInput })`

#### API –ó–∞–ø—Ä–æ—Å:
```typescript
POST /api/world-creation/agent/analyze
Body: {
  sessionId: string,
  userInput: string  // –û–ø–∏—Å–∞–Ω–∏–µ –º–∏—Ä–∞
}

Response: {
  summary: string,         // –ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ
  questions: Array<{       // –í–æ–ø—Ä–æ—Å—ã –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è
    id: string,
    question: string,
    type: 'text' | 'choice'
  }>
}
```

#### –†–µ–∑—É–ª—å—Ç–∞—Ç:
- `$analysis` —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `startGenerationFx(sessionId)` (—á–µ—Ä–µ–∑ sample)
  - –≠—Ç–æ –∑–∞–ø—É—Å–∫–∞–µ—Ç LangGraph –∏ Architect Agent

---

### –®–∞–≥ 3: –£—Ç–æ—á–Ω–µ–Ω–∏–µ –î–µ—Ç–∞–ª–µ–π (Questions / Skeleton Preview)

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç:** `QuestionForm` –∏–ª–∏ `SkeletonPreview`  
**–°–æ—Å—Ç–æ—è–Ω–∏–µ:** `$step = 'questions'`

#### 3.1 Architect —Å–æ–∑–¥–∞–µ—Ç —Å–∫–µ–ª–µ—Ç –º–∏—Ä–∞

–ü–æ—Å–ª–µ –∞–Ω–∞–ª–∏–∑–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –≥—Ä–∞—Ñ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:

```typescript
POST /api/world-creation/agent/generate/{sessionId}/start

Response: {
  status: 'waiting_for_input' | 'completed',
  clarification?: ClarificationRequest,
  world?: WorldData
}
```

#### HITL Request - Skeleton Approval

Architect Agent –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `clarificationRequest`:

```typescript
{
  id: string,
  context: {
    title: string,
    description: string,    // –û–ø–∏—Å–∞–Ω–∏–µ —Å–∫–µ–ª–µ—Ç–∞ –º–∏—Ä–∞
    currentNode: 'architect',
    reason: string
  },
  fields: [{
    id: 'modules',
    type: 'multiselect',
    label: '–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥—É–ª–∏',
    defaultValue: ['hasFactions', 'hasLocations', 'hasRaces', ...]
  }],
  options: {
    allowSkip: false,
    submitLabel: '–£—Ç–≤–µ—Ä–¥–∏—Ç—å –∏ –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å'
  }
}
```

#### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç SkeletonPreview

–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç:
- –ù–∞–∑–≤–∞–Ω–∏–µ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ –º–∏—Ä–∞ (–ø–∞—Å–ø–æ—Ä—Ç)
- –°–ø–∏—Å–æ–∫ –º–æ–¥—É–ª–µ–π (—Ñ—Ä–∞–∫—Ü–∏–∏, –ª–æ–∫–∞—Ü–∏–∏, —Ä–∞—Å—ã, –∏—Å—Ç–æ—Ä–∏—è, –º–∞–≥–∏—è, –ø–µ—Ä—Å–æ–Ω–∞–∂–∏)
- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ –º–æ–¥—É–ª–µ–π
- –¢–µ–∫—Å—Ç–æ–≤–æ–µ –ø–æ–ª–µ –¥–ª—è feedback
- –ö–Ω–æ–ø–∫–∏:
  - "–ü–µ—Ä–µ–¥–µ–ª–∞—Ç—å –°–∫–µ–ª–µ—Ç" (`action: 'refine'`)
  - "–£—Ç–≤–µ—Ä–¥–∏—Ç—å –∏ –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å" (`action: 'approve'`)

#### –ü—Ä–∏ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏:

```typescript
continueGenerationFx({
  sessionId: string,
  response: {
    requestId: string,
    skipped: false,
    answers: {
      modules: ['hasFactions', 'hasLocations', ...],
      feedback: string,
      action: 'approve'  // –∏–ª–∏ 'refine'
    }
  }
})
```

API:
```typescript
POST /api/world-creation/agent/generate/{sessionId}/continue
Body: { response: ClarificationResponse }

Response: {
  status: 'completed' | 'waiting_for_input',
  clarification?: ClarificationRequest,  // –ï—Å–ª–∏ –Ω—É–∂–Ω—ã –µ—â–µ —É—Ç–æ—á–Ω–µ–Ω–∏—è
  world?: WorldData                      // –ï—Å–ª–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞
}
```

#### –†–µ–∑—É–ª—å—Ç–∞—Ç:
- –ï—Å–ª–∏ `action: 'approve'` ‚Üí –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —à–∞–≥ `generating`
- –ï—Å–ª–∏ `action: 'refine'` ‚Üí Architect —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π —Å–∫–µ–ª–µ—Ç

---

### –®–∞–≥ 4: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ú–∏—Ä–∞ (Generation Progress)

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç:** `GenerationProgress`  
**–°–æ—Å—Ç–æ—è–Ω–∏–µ:** `$step = 'generating'`

#### –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:

1. **SSE Stream –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è:**
```typescript
const eventSource = new EventSource(
  `/api/world-creation/agent/generate/${sessionId}/stream`
)
```

2. **–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π —á–µ—Ä–µ–∑ SSE:**

```typescript
// –°–æ–±—ã—Ç–∏–µ: –Ω–∞—á–∞–ª–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∞–≥–µ–Ω—Ç–∞
{
  type: 'node',
  node: 'factions',
  status: 'started',
  timestamp: string
}

// –°–æ–±—ã—Ç–∏–µ: –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∞–≥–µ–Ω—Ç–∞
{
  type: 'node',
  node: 'factions',
  status: 'completed',
  data: { ...generated data... },
  timestamp: string
}

// –°–æ–±—ã—Ç–∏–µ: HITL –∑–∞–ø—Ä–æ—Å –≤–æ –≤—Ä–µ–º—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
{
  type: 'node',
  node: 'magic',
  status: 'waiting_for_input',
  clarification: ClarificationRequest
}

// –°–æ–±—ã—Ç–∏–µ: –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞
{
  type: 'done',
  timestamp: string
}

// –°–æ–±—ã—Ç–∏–µ: –æ—à–∏–±–∫–∞
{
  type: 'error',
  error: string
}
```

3. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI:**
- `$generationProgress` –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∞–≥–µ–Ω—Ç–∞:
  ```typescript
  {
    base: 'completed',      // üåç
    factions: 'in_progress', // ‚öîÔ∏è
    locations: 'pending',    // üè∞
    races: 'pending',        // üë•
    history: 'pending',      // üìú
    magic: 'pending'         // ‚ú®
  }
  ```

4. **HITL –≤–æ –≤—Ä–µ–º—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:**
–ï—Å–ª–∏ –∞–≥–µ–Ω—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, Magic Agent) –Ω—É–∂–Ω–æ —É—Ç–æ—á–Ω–µ–Ω–∏–µ:
- SSE –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `status: 'waiting_for_input'`
- `$clarificationRequest` –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è `ClarificationRenderer` –ø–æ–≤–µ—Ä—Ö –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–≤–µ—á–∞–µ—Ç ‚Üí `continueGenerationFx()`
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è

5. **–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ:**
–ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–æ–±—ã—Ç–∏—è `type: 'done'`:
```typescript
generateWorldFx({ sessionId })
```

API:
```typescript
POST /api/world-creation/agent/generate
Body: { sessionId: string }

Response: WorldData {
  name: string,
  genre: string,
  tone: string,
  world_primer: string,
  factions: Faction[],
  locations: Location[],
  races: Race[],
  history: HistoricalEvent[],
  magic?: MagicSystem,
  characters?: Character[]
}
```

#### –†–µ–∑—É–ª—å—Ç–∞—Ç:
- `$worldData` —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –º–∏—Ä–∞
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —à–∞–≥ `review`

---

### –®–∞–≥ 5: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ (World Review)

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç:** `WorldReview`  
**–°–æ—Å—Ç–æ—è–Ω–∏–µ:** `$step = 'review'`

#### –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:

1. **–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫:**
   - –û–±–∑–æ—Ä (–Ω–∞–∑–≤–∞–Ω–∏–µ, –∂–∞–Ω—Ä, –æ–ø–∏—Å–∞–Ω–∏–µ)
   - –§—Ä–∞–∫—Ü–∏–∏ (—Å–ø–∏—Å–æ–∫ —Å –¥–µ—Ç–∞–ª—è–º–∏)
   - –õ–æ–∫–∞—Ü–∏–∏
   - –†–∞—Å—ã
   - –ò—Å—Ç–æ—Ä–∏—è
   - –ú–∞–≥–∏—è

2. **–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
–í—Å–µ –ø–æ–ª—è –º–æ–∂–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ `updateWorldData()` event

3. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ:**
–ü—Ä–∏ –∫–ª–∏–∫–µ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–∏—Ä":
```typescript
saveWorldFx({ sessionId, worldData })
```

API:
```typescript
POST /api/world-creation/agent/save
Body: {
  sessionId: string,
  worldData: WorldData
}

Response: void (–∏–ª–∏ success)
```

#### –†–µ–∑—É–ª—å—Ç–∞—Ç:
- –ú–∏—Ä —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ PGlite –ë–î
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ Welcome Screen (—á–µ—Ä–µ–∑ sample)

---

## API –ó–∞–ø—Ä–æ—Å—ã

### –ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤:

| –≠–Ω–¥–ø–æ–∏–Ω—Ç | –ú–µ—Ç–æ–¥ | –û–ø–∏—Å–∞–Ω–∏–µ | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–∞ —à–∞–≥–µ |
|----------|-------|----------|----------------------|
| `/api/world-creation/agent/start` | POST | –°—Ç–∞—Ä—Ç —Å–µ—Å—Å–∏–∏ | Genre Selection |
| `/api/world-creation/agent/analyze` | POST | –ê–Ω–∞–ª–∏–∑ –≤–≤–æ–¥–∞ | World Input |
| `/api/world-creation/agent/generate/{sessionId}/start` | POST | –ó–∞–ø—É—Å–∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (Architect) | –ü–æ—Å–ª–µ –∞–Ω–∞–ª–∏–∑–∞ |
| `/api/world-creation/agent/generate/{sessionId}/continue` | POST | –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –ø–æ—Å–ª–µ HITL | Questions/Skeleton |
| `/api/world-creation/agent/generate/{sessionId}/stream` | GET (SSE) | –°—Ç—Ä–∏–º –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ | Generation Progress |
| `/api/world-creation/agent/generate` | POST | –ü–æ–ª—É—á–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ–≥–æ –º–∏—Ä–∞ | –ü–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ |
| `/api/world-creation/agent/save` | POST | –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–∏—Ä–∞ | World Review |

---

## –ü–æ—Ç–æ–∫–∏ –î–∞–Ω–Ω—ã—Ö

### 1. –£—Å–ø–µ—à–Ω—ã–π Flow (–±–µ–∑ —É—Ç–æ—á–Ω–µ–Ω–∏–π)

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí GenreSelection
                    ‚Üì
            startSessionFx()
                    ‚Üì
            [sessionId —Å–æ—Ö—Ä–∞–Ω–µ–Ω] ‚Üí –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ 'input'
                    ‚Üì
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí WorldInput (–≤–≤–æ–¥–∏—Ç —Ç–µ–∫—Å—Ç)
                    ‚Üì
            analyzeInputFx()
                    ‚Üì
            [analysis —Å–æ—Ö—Ä–∞–Ω–µ–Ω]
                    ‚Üì
            startGenerationFx() (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
                    ‚Üì
            [Architect –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç skeleton]
                    ‚Üì
            $clarificationRequest –æ–±–Ω–æ–≤–ª–µ–Ω ‚Üí –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ 'questions'
                    ‚Üì
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí SkeletonPreview (–≤—ã–±–∏—Ä–∞–µ—Ç –º–æ–¥—É–ª–∏, —É—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç)
                    ‚Üì
            continueGenerationFx({ action: 'approve' })
                    ‚Üì
            [status = 'generating'] ‚Üí –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ 'generating'
                    ‚Üì
            SSE Stream –ø–æ–¥–∫–ª—é—á–µ–Ω
                    ‚Üì
            [–°–æ–±—ã—Ç–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –æ–±–Ω–æ–≤–ª—è—é—Ç $generationProgress]
                    ‚Üì
            [–°–æ–±—ã—Ç–∏–µ 'done']
                    ‚Üì
            generateWorldFx()
                    ‚Üì
            [$worldData —Å–æ—Ö—Ä–∞–Ω–µ–Ω] ‚Üí –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ 'review'
                    ‚Üì
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí WorldReview (–ø—Ä–æ–≤–µ—Ä—è–µ—Ç, —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç)
                    ‚Üì
            saveWorldFx()
                    ‚Üì
            [–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ] ‚Üí –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ Welcome
```

### 2. Flow —Å HITL –£—Ç–æ—á–Ω–µ–Ω–∏—è–º–∏

```
... (—Ç–æ –∂–µ –¥–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏)
            SSE Stream
                    ‚Üì
            base ‚Üí completed
            factions ‚Üí completed
            locations ‚Üí completed
            magic ‚Üí waiting_for_input (–Ω—É–∂–Ω–æ —É—Ç–æ—á–Ω–µ–Ω–∏–µ!)
                    ‚Üì
            [$clarificationRequest –æ–±–Ω–æ–≤–ª–µ–Ω]
                    ‚Üì
            [–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è ClarificationRenderer]
                    ‚Üì
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã
                    ‚Üì
            continueGenerationFx(response)
                    ‚Üì
            [–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è]
                    ‚Üì
            magic ‚Üí completed
            races ‚Üí completed
            history ‚Üí completed
                    ‚Üì
            [–°–æ–±—ã—Ç–∏–µ 'done'] ‚Üí generateWorldFx()
                    ‚Üì
            ... (–ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –∫–∞–∫ –æ–±—ã—á–Ω–æ)
```

### 3. Flow —Å –ü–µ—Ä–µ–¥–µ–ª–∫–æ–π –°–∫–µ–ª–µ—Ç–∞

```
... (–ø–æ—Å–ª–µ analyzeInputFx)
            startGenerationFx()
                    ‚Üì
            [Architect —Å–æ–∑–¥–∞–ª skeleton #1]
                    ‚Üì
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí SkeletonPreview
                    ‚Üì
            "–ü–µ—Ä–µ–¥–µ–ª–∞—Ç—å –°–∫–µ–ª–µ—Ç" (action: 'refine', feedback: "—Å–¥–µ–ª–∞–π —Ç–µ–º–Ω–µ–µ")
                    ‚Üì
            continueGenerationFx({ action: 'refine', feedback })
                    ‚Üì
            [Architect —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π skeleton #2 —Å —É—á–µ—Ç–æ–º feedback]
                    ‚Üì
            [$clarificationRequest –æ–±–Ω–æ–≤–ª–µ–Ω —Å –Ω–æ–≤—ã–º —Å–∫–µ–ª–µ—Ç–æ–º]
                    ‚Üì
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí SkeletonPreview (–Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è)
                    ‚Üì
            "–£—Ç–≤–µ—Ä–¥–∏—Ç—å" (action: 'approve')
                    ‚Üì
            ... (–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è)
```

---

## –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã UI

### Wizard (wizard.tsx)

**–†–æ–ª—å:** –ì–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä wizard  
**–û—Ç–≤–µ—á–∞–µ—Ç –∑–∞:**
- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ Stepper (–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–æ–≥—Ä–µ—Å—Å–∞)
- –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –Ω—É–∂–Ω–æ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ `$step`
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- –î–∏–∞–ª–æ–≥ –≤—ã—Ö–æ–¥–∞

**–ú–∞–ø–ø–∏–Ω–≥ —à–∞–≥–æ–≤:**
```typescript
'setting'    ‚Üí Stepper index 0 ‚Üí GenreSelection
'input'      ‚Üí Stepper index 1 ‚Üí WorldInput
'questions'  ‚Üí Stepper index 2 ‚Üí QuestionForm –∏–ª–∏ SkeletonPreview
'generating' ‚Üí Stepper index 2 ‚Üí GenerationProgress
'review'     ‚Üí Stepper index 3 ‚Üí WorldReview
```

### GenreSelection (genre-selection.tsx)

**UI:**
- –ö–∞—Ä—Ç–æ—á–∫–∏ —Å –∂–∞–Ω—Ä–∞–º–∏
- –û–ø–∏—Å–∞–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ –∂–∞–Ω—Ä–∞
- –ö–Ω–æ–ø–∫–∞ –≤—ã–±–æ—Ä–∞

**–î–µ–π—Å—Ç–≤–∏—è:**
- –ö–ª–∏–∫ ‚Üí `setSetting()` + `startSessionFx()`

### WorldInput (world-input.tsx)

**UI:**
- –ë–æ–ª—å—à–æ–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –ø–æ–ª–µ (multiline, 8 rows)
- Suggestions chips (–±—ã—Å—Ç—Ä–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ)
- –°—á–µ—Ç—á–∏–∫ —Å–∏–º–≤–æ–ª–æ–≤
- –ö–Ω–æ–ø–∫–∏: "–£–¥–∏–≤–∏ –º–µ–Ω—è", "–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å"

**–î–µ–π—Å—Ç–≤–∏—è:**
- –í–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞ ‚Üí `setUserInput()`
- "–£–¥–∏–≤–∏ –º–µ–Ω—è" ‚Üí –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ + `analyzeInputFx()`
- "–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å" ‚Üí `analyzeInputFx()`

### SkeletonPreview (skeleton-preview.tsx)

**UI:**
- –ü–∞—Å–ø–æ—Ä—Ç –º–∏—Ä–∞ (–Ω–∞–∑–≤–∞–Ω–∏–µ, –æ–ø–∏—Å–∞–Ω–∏–µ)
- –°–ø–∏—Å–æ–∫ –º–æ–¥—É–ª–µ–π —Å –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è–º–∏ (Switch)
  - –§—Ä–∞–∫—Ü–∏–∏ –∏ –ü–æ–ª–∏—Ç–∏–∫–∞
  - –õ–æ–∫–∞—Ü–∏–∏ –∏ –ì–µ–æ–≥—Ä–∞—Ñ–∏—è
  - –†–∞—Å—ã –∏ –í–∏–¥—ã
  - –ò—Å—Ç–æ—Ä–∏—è –∏ –•—Ä–æ–Ω–æ–ª–æ–≥–∏—è
  - –ú–∞–≥–∏—è –∏ –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏
  - –ö–ª—é—á–µ–≤—ã–µ –ü–µ—Ä—Å–æ–Ω–∞–∂–∏
- –¢–µ–∫—Å—Ç–æ–≤–æ–µ –ø–æ–ª–µ –¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
- –ö–Ω–æ–ø–∫–∏: "–ü–µ—Ä–µ–¥–µ–ª–∞—Ç—å –°–∫–µ–ª–µ—Ç", "–£—Ç–≤–µ—Ä–¥–∏—Ç—å –∏ –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å"

**–î–µ–π—Å—Ç–≤–∏—è:**
- –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–æ–¥—É–ª–µ–π ‚Üí –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ state
- –í–≤–æ–¥ feedback ‚Üí –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ state
- "–ü–µ—Ä–µ–¥–µ–ª–∞—Ç—å" ‚Üí `continueGenerationFx({ action: 'refine', ... })`
- "–£—Ç–≤–µ—Ä–¥–∏—Ç—å" ‚Üí `continueGenerationFx({ action: 'approve', ... })`

### QuestionForm (question-form.tsx)

**–†–æ–ª—å:** –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ–æ—Ä–º–∞ –¥–ª—è HITL –≤–æ–ø—Ä–æ—Å–æ–≤

**UI:**
- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ –∏–∑ `clarificationRequest.context`
- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –ø–æ–ª—è –Ω–∞ –æ—Å–Ω–æ–≤–µ `clarificationRequest.fields`:
  - `type: 'text'` ‚Üí TextField
  - `type: 'textarea'` ‚Üí TextField multiline
  - `type: 'radio'` ‚Üí RadioGroup
  - `type: 'multiselect'` ‚Üí FormGroup —Å Checkbox
- –ö–Ω–æ–ø–∫–∏: "Skip" (–µ—Å–ª–∏ allowed), "Submit"

**–î–µ–π—Å—Ç–≤–∏—è:**
- –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ–ª–µ–π ‚Üí –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ `answers`
- Submit ‚Üí `continueGenerationFx({ response: { answers } })`

### GenerationProgress (generation-progress.tsx)

**UI:**
- –ö—Ä–∞—Å–∏–≤—ã–π —Ç–µ–º–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–º
- –°–µ—Ç–∫–∞ 3x2 –∫–∞—Ä—Ç–æ—á–µ–∫ –∞–≥–µ–Ω—Ç–æ–≤:
  - üåç –û—Å–Ω–æ–≤–∞ –º–∏—Ä–∞
  - ‚öîÔ∏è –§—Ä–∞–∫—Ü–∏–∏
  - üè∞ –õ–æ–∫–∞—Ü–∏–∏
  - üë• –†–∞—Å—ã
  - üìú –ò—Å—Ç–æ—Ä–∏—è
  - ‚ú® –ú–∞–≥–∏—è
- –ö–∞–∂–¥–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç:
  - –ò–∫–æ–Ω–∫—É (emoji)
  - –ù–∞–∑–≤–∞–Ω–∏–µ
  - –°—Ç–∞—Ç—É—Å: "–û–∂–∏–¥–∞–Ω–∏–µ" | "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è..." | "–ì–æ—Ç–æ–≤–æ" | "–û—à–∏–±–∫–∞"
  - –ê–Ω–∏–º–∞—Ü–∏–∏ (pulse –¥–ª—è in_progress, fadeIn –¥–ª—è –ø–æ—è–≤–ª–µ–Ω–∏—è)
- –°—á–µ—Ç—á–∏–∫ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞: "–°–æ–∑–¥–∞–Ω–∏–µ –º–∏—Ä–∞ (3/6)"

**–î–µ–π—Å—Ç–≤–∏—è:**
- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ SSE –ø—Ä–∏ mount
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ `$generationProgress` –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–æ–±—ã—Ç–∏–π
- –ü—Ä–∏ HITL ‚Üí –ø–æ–∫–∞–∑ `ClarificationRenderer` –ø–æ–≤–µ—Ä—Ö
- –ü—Ä–∏ 'done' ‚Üí `generateWorldFx()`

### WorldReview (world-review.tsx)

**UI:**
- Tabs –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ä–∞–∑–¥–µ–ª–æ–≤ –º–∏—Ä–∞
- –ö–∞–∂–¥–∞—è –≤–∫–ª–∞–¥–∫–∞ —Å Accordion –¥–ª—è —Å–ø–∏—Å–∫–æ–≤ (—Ñ—Ä–∞–∫—Ü–∏–∏, –ª–æ–∫–∞—Ü–∏–∏ –∏ —Ç.–¥.)
- –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–µ TextField –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª–µ–π
- –ö–Ω–æ–ø–∫–∞ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–∏—Ä" –≤–Ω–∏–∑—É

**–î–µ–π—Å—Ç–≤–∏—è:**
- –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Üí `updateWorldData()`
- "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–∏—Ä" ‚Üí `saveWorldFx()`

---

## –ò—Ç–æ–≥–æ–≤–∞—è –î–∏–∞–≥—Ä–∞–º–º–∞ –ü—Ä–æ—Ü–µ—Å—Å–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Genre Selection ‚îÇ
‚îÇ   (setting)     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ startSessionFx()
         ‚ñº
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇsessionId
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  World Input     ‚îÇ
‚îÇ    (input)       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ analyzeInputFx()
         ‚ñº
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ analysis‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ startGenerationFx()
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Architect Agent     ‚îÇ
‚îÇ (creates skeleton)  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ clarificationRequest
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Skeleton Preview    ‚îÇ
‚îÇ   (questions)       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ continueGenerationFx({ action: 'approve' })
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Generation Progress ‚îÇ
‚îÇ   (generating)      ‚îÇ  ‚óÑ‚îÄ‚îÄ‚îÄ SSE Stream ‚îÄ‚îÄ‚îÄ‚îê
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                     ‚îÇ
         ‚îÇ                                  ‚îÇ
         ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ HITL? ‚îÄ‚îÄ‚îÄ‚ñ∫‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
         ‚îÇ                ‚îÇ Questions  ‚îÇ   ‚îÇ
         ‚îÇ                ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
         ‚îÇ                                  ‚îÇ
         ‚îÇ generateWorldFx()                ‚îÇ
         ‚ñº                                  ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                            ‚îÇ
    ‚îÇworldData‚îÇ                            ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò                            ‚îÇ
         ‚îÇ                                  ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                       ‚îÇ
‚îÇ  World Review    ‚îÇ                       ‚îÇ
‚îÇ    (review)      ‚îÇ                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                       ‚îÇ
         ‚îÇ saveWorldFx()                   ‚îÇ
         ‚ñº                                  ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                        ‚îÇ
‚îÇ Welcome Screen  ‚îÇ                        ‚îÇ
‚îÇ  (–º–∏—Ä —Å–æ—Ö—Ä–∞–Ω–µ–Ω) ‚îÇ                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                        ‚îÇ
                                           ‚îÇ
Backend LangGraph ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## –ö–ª—é—á–µ–≤—ã–µ –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

### 1. –†–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (Effector)
- –í—Å–µ –ø–µ—Ä–µ—Ö–æ–¥—ã –º–µ–∂–¥—É —à–∞–≥–∞–º–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ `sample` –≤ `init.ts`
- –ù–µ—Ç –∏–º–ø–µ—Ä–∞—Ç–∏–≤–Ω—ã—Ö –Ω–∞–≤–∏–≥–∞—Ü–∏–π –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö
- –ï–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã –¥–ª—è —Å–æ—Å—Ç–æ—è–Ω–∏—è

### 2. Human-in-the-Loop (HITL)
- Architect –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–∫–µ–ª–µ—Ç –¥–ª—è —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
- –ê–≥–µ–Ω—Ç—ã –º–æ–≥—É—Ç –∑–∞–ø—Ä–æ—Å–∏—Ç—å —É—Ç–æ—á–Ω–µ–Ω–∏—è –≤–æ –≤—Ä–µ–º—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
- –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ `ClarificationRequest` / `ClarificationResponse`

### 3. SSE Streaming
- –†–µ–∞–ª-—Ç–∞–π–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
- –í–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∞–≥–µ–Ω—Ç–∞
- Graceful fallback –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö SSE

### 4. –ì–∏–±–∫–æ—Å—Ç—å
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –Ω–∞–ø–∏—Å–∞—Ç—å "—É–¥–∏–≤–∏ –º–µ–Ω—è" - AI —Å–∞–º –≤—Å–µ –ø—Ä–∏–¥—É–º–∞–µ—Ç
- –ú–æ–∂–Ω–æ –¥–∞–≤–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ - AI –∑–∞–¥–∞—Å—Ç —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã
- –°–∫–µ–ª–µ—Ç –º–æ–∂–Ω–æ –ø–µ—Ä–µ–¥–µ–ª—ã–≤–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ —Å feedback
- –ú–æ–¥—É–ª–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤—ã–±–∏—Ä–∞—é—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ü—Ä–æ—Ü–µ—Å—Å —Å–æ–∑–¥–∞–Ω–∏—è –º–∏—Ä–∞ - —ç—Ç–æ —Å–ª–æ–∂–Ω—ã–π multi-step flow —Å AI-–∞–≥–µ–Ω—Ç–∞–º–∏, HITL –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ–º –∏ —Ä–µ–∞–ª-—Ç–∞–π–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏. 

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ –∏—Ç–æ–≥–µ:**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–∞–µ—Ç –Ω–∞—á–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –º–∏—Ä–∞ (–∏–ª–∏ –ø—Ä–æ—Å–∏—Ç "—É–¥–∏–≤–∏—Ç—å")
2. AI –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∏ —Å–æ–∑–¥–∞–µ—Ç —Å–∫–µ–ª–µ—Ç –º–∏—Ä–∞
3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç —Å–∫–µ–ª–µ—Ç –∏ –≤—ã–±–∏—Ä–∞–µ—Ç –º–æ–¥—É–ª–∏
4. AI –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ –º–æ–¥—É–ª—è–º (—Ñ—Ä–∞–∫—Ü–∏–∏, –ª–æ–∫–∞—Ü–∏–∏ –∏ —Ç.–¥.)
5. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ë–æ–≥–∞—Ç—ã–π, –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∏–≥—Ä–æ–≤–æ–π –º–∏—Ä, –≥–æ—Ç–æ–≤—ã–π –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏—è—Ö.
